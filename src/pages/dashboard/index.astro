---
import DashboardLayout from "@/layouts/DashboardLayout.astro";
import { getSession } from "@/auth/dal";
import Layout from "@/layouts/Layout.astro";
import DashboardPage from "@/components/react/dashboard-page";
import {
    getGeneralStats,
    getRecentPackagesByOffice,
    type DashboardStats,
} from "@/db/queries";

const session = await getSession(Astro.request);
/* const session = () => {
    if (Astro.locals.session) {
        return Astro.locals.user;
    } else {
        // Redirect to login page if the user is not authenticated
        return Astro.redirect("/login");
    }
};
*/
if (!session) {
    return Astro.redirect("/signin");
}

const period = Astro.url.searchParams.get("period") || "all"; // Default to 'all'
const stats = await getGeneralStats(period);
const recentPackages = await getRecentPackagesByOffice();
---

<DashboardLayout>
    <DashboardPage
        stats={stats}
        recentPackages={recentPackages}
        session={session!}
        isAdmin={session.user.role === "ADMIN"}
        client:load
    />
</DashboardLayout>
